<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Âπ≥ÊùøÂÄüÈÇÑÁ≥ªÁµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    /* Reset and Base Styles */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, 'ÂæÆËªüÊ≠£ÈªëÈ´î', sans-serif;
      background: 
        url('cyberpunk_background.png'),
        linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: 400px 400px, cover;
      background-repeat: repeat, no-repeat;
      background-blend-mode: overlay;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem 2rem;
      color: #1d1d1f;
      line-height: 1.7;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 4rem 3.5rem;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 60%);
      z-index: -1;
      animation: shimmer 3s infinite;
      transform: skewX(-20deg);
    }

    @keyframes shimmer {
      0% { transform: translateX(-150%) skewX(-20deg); }
      100% { transform: translateX(150%) skewX(-20deg); }
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      text-align: center;
      background: linear-gradient(135deg, #5f72bd 0%, #9b23ea 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
    }

    .timestamp {
      text-align: center;
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 2rem;
    }

    .subtitle {
      text-align: center;
      font-size: 1rem;
      color: #666;
      margin-bottom: 2.5rem;
    }

    .form-section {
      margin-bottom: 2rem;
      border-radius: 16px;
      padding: 1.5rem;
      background: rgba(240, 240, 255, 0.5);
      border: 1px solid rgba(200, 200, 255, 0.3);
    }

    .form-section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #5f72bd;
      border-bottom: 2px solid rgba(95, 114, 189, 0.2);
      padding-bottom: 0.5rem;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .radio-option {
      flex: 1;
      min-width: 150px;
      background: white;
      border: 2px solid rgba(95, 114, 189, 0.2);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .radio-option.selected {
      border-color: #5f72bd;
      background: rgba(95, 114, 189, 0.05);
      box-shadow: 0 5px 15px rgba(95, 114, 189, 0.1);
    }

    .radio-option input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .radio-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 500;
      color: #444;
    }

    .radio-option.selected label {
      color: #5f72bd;
      font-weight: 600;
    }

    .radio-option .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      transition: transform 0.3s ease;
    }

    .radio-option:hover .icon {
      transform: scale(1.1);
    }

    .radio-option.selected .icon {
      transform: scale(1.2);
      color: #5f72bd;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #444;
    }

    .form-group input[type="text"],
    .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(95, 114, 189, 0.2);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-group input[type="text"]:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #5f72bd;
      box-shadow: 0 0 0 3px rgba(95, 114, 189, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .checkbox-option {
      background: white;
      border: 2px solid rgba(95, 114, 189, 0.2);
      border-radius: 12px;
      padding: 0.8rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
    }

    .checkbox-option.checked {
      border-color: #5f72bd;
      background: rgba(95, 114, 189, 0.05);
      box-shadow: 0 5px 15px rgba(95, 114, 189, 0.1);
    }

    .checkbox-option input {
      margin-right: 10px;
    }

    .checkbox-option label {
      cursor: pointer;
      font-weight: 500;
      color: #444;
      flex: 1;
    }

    .checkbox-option.checked label {
      color: #5f72bd;
      font-weight: 600;
    }

    .qr-section {
      margin-bottom: 1.5rem;
    }

    .qr-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .qr-btn {
      flex: 1;
      background: #5f72bd;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-btn:hover {
      background: #4a5d9d;
      transform: translateY(-2px);
    }

    .qr-btn:active {
      transform: translateY(0);
    }

    #stopQrBtn {
      background: #e74c3c;
      display: none;
    }

    #stopQrBtn:hover {
      background: #c0392b;
    }

    #qr-video {
      width: 100%;
      border-radius: 12px;
      display: none;
      margin-bottom: 1rem;
    }

    #qr-result {
      background: rgba(95, 114, 189, 0.1);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: none;
      animation: fadeIn 0.5s ease;
    }

    #qr-result.show {
      display: block;
    }

    .submit-btn {
      background: linear-gradient(135deg, #5f72bd 0%, #9b23ea 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      width: 100%;
      margin-top: 2rem;
      position: relative;
      overflow: hidden;
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 60%);
      z-index: 1;
      animation: shimmer 3s infinite;
      transform: skewX(-20deg);
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(95, 114, 189, 0.3);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .message {
      text-align: center;
      margin-top: 1rem;
      padding: 0.5rem;
      border-radius: 8px;
      font-weight: 500;
      min-height: 2.5rem;
    }

    .message.error {
      background: rgba(231, 76, 60, 0.1);
      color: #e74c3c;
    }

    .message.success {
      background: rgba(46, 204, 113, 0.1);
      color: #2ecc71;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 3rem 2rem;
        margin: 1rem;
      }
      
      .radio-group {
        flex-direction: column;
      }
      
      .radio-option {
        width: 100%;
      }
      
      .checkbox-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Âπ≥ÊùøÂÄüÈÇÑÁ≥ªÁµ±</h1>
    <div class="timestamp" id="timestamp"></div>
    <div class="subtitle">ÊéÉÊèèQRÁ¢ºÊàñÊâãÂãïËº∏ÂÖ•Â≠∏ÁîüË≥áË®äÈÄ≤Ë°åÂπ≥ÊùøÂÄüÈÇÑÁôªË®ò</div>
    
    <form id="borrowForm">
      <!-- Êìç‰ΩúÈ°ûÂûã -->
      <div class="form-section">
        <div class="form-section-title">Êìç‰ΩúÈ°ûÂûã</div>
        <div class="radio-group">
          <div class="radio-option" onclick="selectOption(this)">
            <input type="radio" id="borrow" name="operation" value="borrow" required>
            <label for="borrow">
              <span class="icon">üì±</span>
              ÂÄüÂá∫Âπ≥Êùø
            </label>
          </div>
          <div class="radio-option" onclick="selectOption(this)">
            <input type="radio" id="return" name="operation" value="return" required>
            <label for="return">
              <span class="icon">üîÑ</span>
              Ê≠∏ÈÇÑÂπ≥Êùø
            </label>
          </div>
        </div>
      </div>
      
      <!-- Â≠∏ÁîüË≥áË®ä -->
      <div class="form-section">
        <div class="form-section-title">Â≠∏ÁîüË≥áË®ä</div>
        
        <div class="qr-section">
          <div class="qr-buttons">
            <button type="button" id="startQrBtn" class="qr-btn">ÈñãÂßãÊéÉÊèèQRÁ¢º</button>
            <button type="button" id="stopQrBtn" class="qr-btn">ÂÅúÊ≠¢ÊéÉÊèè</button>
          </div>
          <video id="qr-video"></video>
          <div id="qr-result">
            <span id="qr-result-text"></span>
          </div>
        </div>
        
        <!-- Â≠∏ÁîüÂßìÂêç -->
        <div class="form-group">
          <label for="studentName">Â≠∏ÁîüÂßìÂêç <small>ÂèØÈÄöÈÅéQRÁ¢ºËá™ÂãïÂ°´ÂÖ•</small></label>
          <input type="text" id="studentName" name="studentName" placeholder="Ë´ãËº∏ÂÖ•Â≠∏ÁîüÂßìÂêçÊàñÊéÉÊèèQRÁ¢º" required>
        </div>
        
        <!-- Â∫èËôü -->
        <div class="form-group">
          <label for="studentId">Â∫èËôü <small>ÂèØÈÄöÈÅéQRÁ¢ºËá™ÂãïÂ°´ÂÖ•</small></label>
          <input type="text" id="studentId" name="studentId" placeholder="Ë´ãËº∏ÂÖ•Â∫èËôü" required>
        </div>
      </div>

      <!-- ÂÖ∂‰ªñÂïèÈ°å -->
      <div class="form-section">
        <div class="form-section-title">ÂÖ∂‰ªñÂïèÈ°å</div>
        <div class="checkbox-group">
          <div class="checkbox-option">
            <input type="checkbox" id="issue1" name="issues" value="ÈõªÊ±†‰∏çË∂≥">
            <label for="issue1">üîã ÈõªÊ±†‰∏çË∂≥</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="issue2" name="issues" value="ÁÑ°Ê≥ïÈñãÊ©ü">
            <label for="issue2">‚ö° ÁÑ°Ê≥ïÈñãÊ©ü</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="issue3" name="issues" value="WiFiÈÄ£Êé•ÂïèÈ°å">
            <label for="issue3">üì∂ WiFiÈÄ£Êé•ÂïèÈ°å</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="issue4" name="issues" value="Èü≥Ë®äÂïèÈ°å">
            <label for="issue4">üîä Èü≥Ë®äÂïèÈ°å</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="issue5" name="issues" value="È°ØÁ§∫Áï∞Â∏∏">
            <label for="issue5">üì± È°ØÁ§∫Áï∞Â∏∏</label>
          </div>
          <div class="checkbox-option">
            <input type="checkbox" id="issue6" name="issues" value="Á°¨È´îÊêçÂ£û">
            <label for="issue6">üîß Á°¨È´îÊêçÂ£û</label>
          </div>
        </div>
        <div class="form-group">
          <label for="customIssue">ÂÖ∂‰ªñÂïèÈ°åË™™ÊòéÔºö</label>
          <textarea id="customIssue" name="customIssue" placeholder="Â¶ÇÊúâÂÖ∂‰ªñÂïèÈ°åË´ãÂú®Ê≠§ÊèèËø∞..."></textarea>
        </div>
      </div>
      
      <!-- ÂÇôË®ª -->
      <div class="form-section">
        <div class="form-section-title">ÂÇôË®ª</div>
        <div class="form-group">
          <textarea id="remarks" name="remarks" placeholder="ÂÖ∂‰ªñÂÇôË®ª‰ø°ÊÅØ..."></textarea>
        </div>
      </div>
      
      <button type="submit" id="submitBtn" class="submit-btn">Êèê‰∫§Ë®òÈåÑ</button>
      <div id="message" class="message"></div>
    </form>
  </div>

  <script>
    // Ë®≠ÁΩÆAPI URL
    const apiUrl = "https://script.google.com/macros/s/AKfycbwHfbnR8gz7gP-ddvO81joSSAMBxcvYUHTRfdOrJYlUrVjQN6JXtsdr36ZvrEYRYvin/exec";
    
    // È°ØÁ§∫Áï∂ÂâçÊó•ÊúüÂíåÊôÇÈñì
    function updateTimestamp() {
      const now = new Date();
      const options = { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false
      };
      document.getElementById('timestamp').textContent = now.toLocaleString('zh-TW', options);
    }
    
    // ÂàùÂßãÂåñ‰∏¶ÊØèÁßíÊõ¥Êñ∞ÊôÇÈñì
    updateTimestamp();
    setInterval(updateTimestamp, 1000);
    
    // ÈÅ∏ÊìáÊìç‰ΩúÈ°ûÂûã
    function selectOption(element) {
      // ÁßªÈô§ÊâÄÊúâÈÅ∏È†ÖÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
      document.querySelectorAll('.radio-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Ê∑ªÂä†ÈÅ∏‰∏≠ÁãÄÊÖãÂà∞Áï∂ÂâçÈÅ∏È†Ö
      element.classList.add('selected');
      
      // ÈÅ∏‰∏≠ÂñÆÈÅ∏ÊåâÈàï
      const radio = element.querySelector('input[type="radio"]');
      radio.checked = true;
    }
    
    // QRÁ¢ºÊéÉÊèèÁõ∏ÈóúËÆäÈáè
    let codeReader;
    let isScanning = false;
    
    // ÈñãÂßãQRÁ¢ºÊéÉÊèè
    document.getElementById('startQrBtn').addEventListener('click', async function() {
      try {
        const startBtn = document.getElementById('startQrBtn');
        const stopBtn = document.getElementById('stopQrBtn');
        const video = document.getElementById('qr-video');
        
        if (isScanning) return;
        isScanning = true;
        
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        video.style.display = 'block';
        
        showMessage('Ê≠£Âú®ÂïüÂãïÊîùÂÉèÈ†≠...');
        
        // ÂàùÂßãÂåñQRÁ¢ºÊéÉÊèèÂô®
        codeReader = new ZXing.BrowserMultiFormatReader();
        
        // Áç≤ÂèñÂèØÁî®ÁöÑË¶ñÈ†ªË®≠ÂÇô
        const videoInputDevices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        
        // ÂÑ™ÂÖàÈÅ∏ÊìáÂæåÁΩÆÊîùÂÉèÈ†≠ÔºàÈÅ©Áî®ÊñºiPadÔºâ
        let selectedDeviceId = null;
        
        if (videoInputDevices.length > 0) {
          // ÂòóË©¶ÊâæÂà∞ÂæåÁΩÆÊîùÂÉèÈ†≠
          for (const device of videoInputDevices) {
            if (device.label.toLowerCase().includes('back') || 
                device.label.toLowerCase().includes('Âæå') || 
                device.label.toLowerCase().includes('rear')) {
              selectedDeviceId = device.deviceId;
              break;
            }
          }
          
          // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ÂæåÁΩÆÊîùÂÉèÈ†≠Ôºå‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂèØÁî®ÁöÑÊîùÂÉèÈ†≠
          if (!selectedDeviceId) {
            selectedDeviceId = videoInputDevices[0].deviceId;
          }
        }
        
        // ÈñãÂßãËß£Á¢º
        const constraints = selectedDeviceId 
          ? { video: { deviceId: selectedDeviceId } } 
          : { video: { facingMode: 'environment' } };
        
        await codeReader.decodeFromConstraints(
          constraints,
          'qr-video',
          (result, err) => {
            if (err) {
              // ÂøΩÁï•ÈåØË™§ÔºåÁπºÁ∫åÊéÉÊèè
              return;
            }
            
            if (result) {
              // ËôïÁêÜÊéÉÊèèÁµêÊûú
              handleQrResult(result.text);
              stopQrScanner();
            }
          }
        );

      } catch (error) {
        console.error('QRÊéÉÊèèÈåØË™§:', error);
        showMessage('ÊîùÂÉèÈ†≠ÂïüÂãïÂ§±ÊïóÔºö' + error.message, 'error');
        stopQrScanner();
      }
    });
    
    // ÂÅúÊ≠¢QRÁ¢ºÊéÉÊèè
    document.getElementById('stopQrBtn').addEventListener('click', stopQrScanner);
    
    function stopQrScanner() {
      const startBtn = document.getElementById('startQrBtn');
      const stopBtn = document.getElementById('stopQrBtn');
      const video = document.getElementById('qr-video');
      
      isScanning = false;
      
      if (codeReader) {
        codeReader.reset();
      }
      
      video.style.display = 'none';
      startBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      
      showMessage('', '');
    }
    
    // ËôïÁêÜQRÁ¢ºÊéÉÊèèÁµêÊûú
    function handleQrResult(qrText) {
      try {
        // ÂòóË©¶Ëß£ÊûêJSONÊ†ºÂºèÁöÑQRÁ¢º
        let studentData;
        
        try {
          studentData = JSON.parse(qrText);
        } catch (e) {
          // Â¶ÇÊûú‰∏çÊòØJSONÔºåÂòóË©¶ÂÖ∂‰ªñÊ†ºÂºè
          // ÂÅáË®≠Ê†ºÂºèÁÇ∫ÔºöÂßìÂêç|Â∫èËôü
          const parts = qrText.split('|');
          if (parts.length >= 2) {
            studentData = {
              name: parts[0],
              studentId: parts[1]
            };
          } else {
            throw new Error('QRÁ¢ºÊ†ºÂºè‰∏çÊ≠£Á¢∫');
          }
        }
        
        // Â°´ÂÖ•Ë°®ÂñÆ
        if (studentData.name) {
          document.getElementById('studentName').value = studentData.name;
        }
        if (studentData.studentId) {
          document.getElementById('studentId').value = studentData.studentId;
        }
        
        // È°ØÁ§∫ÁµêÊûú
        const resultDiv = document.getElementById('qr-result');
        const resultText = document.getElementById('qr-result-text');
        resultText.textContent = `‚úÖ Â∑≤ËÆÄÂèñÔºö${studentData.name || ''} (${studentData.studentId || ''})`;
        resultDiv.classList.add('show');
        
        showMessage('QRÁ¢ºÊéÉÊèèÊàêÂäüÔºÅ', 'success');
        
      } catch (error) {
        console.error('QRÁ¢ºËß£ÊûêÈåØË™§:', error);
        showMessage('QRÁ¢ºÊ†ºÂºèÈåØË™§ÔºåË´ãÊâãÂãïËº∏ÂÖ•Â≠∏ÁîüË≥áË®ä', 'error');
      }
    }
    
    // È°ØÁ§∫Ë®äÊÅØ
    function showMessage(text, type = '') {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = 'message' + (type ? ' ' + type : '');
    }
    
    // Ë°®ÂñÆÊèê‰∫§
    document.getElementById('borrowForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // ËôïÁêÜcheckboxÈÅ∏È†Ö
      const checkedIssues = [];
      const checkboxes = document.querySelectorAll('input[name="issues"]:checked');
      checkboxes.forEach(checkbox => {
        checkedIssues.push(checkbox.value);
      });
      
      // Áç≤ÂèñËá™ÂÆöÁæ©ÂïèÈ°åÊèèËø∞
      const customIssue = document.getElementById('customIssue').value.trim();
      
      // Âêà‰ΩµÂïèÈ°åÊèèËø∞
      let allIssues = '';
      if (checkedIssues.length > 0) {
        allIssues = checkedIssues.join('„ÄÅ');
      }
      if (customIssue) {
        if (allIssues) {
          allIssues += '„ÄÅ' + customIssue;
        } else {
          allIssues = customIssue;
        }
      }
      
      const formData = new FormData(this);
      
      // ÁßªÈô§ÂéüÊúâÁöÑissuesÊ¨Ñ‰ΩçÔºåÊ∑ªÂä†Âêà‰ΩµÂæåÁöÑÂïèÈ°åÊèèËø∞
      formData.delete('issues');
      formData.delete('customIssue');
      formData.append('issues', allIssues);
      
      const message = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');
      let isTimeout = false;
      
      // ÂÅúÊ≠¢QRÊéÉÊèèÔºàÂ¶ÇÊûúÊ≠£Âú®ÈÄ≤Ë°åÔºâ
      if (isScanning) {
        stopQrScanner();
      }
      
      // Á¶ÅÁî®Êèê‰∫§ÊåâÈàï‰∏¶È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
      submitBtn.disabled = true;
      submitBtn.textContent = 'Êèê‰∫§‰∏≠...';
      showMessage('Ë´ãÁ®çÂÄô... Ê≠£Âú®Êèê‰∫§‰∏≠');
      
      const timeoutId = setTimeout(() => {
        isTimeout = true;
        showMessage('‰º∫ÊúçÂô®ÁπÅÂøôÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Êèê‰∫§Ë®òÈåÑ';
      }, 15000);
      
      try {
        const response = await fetch(apiUrl, { 
          method: 'POST', 
          body: formData 
        });
        const text = await response.text();
        
        if (isTimeout) return;
        clearTimeout(timeoutId);
        
        if (text.trim() === "OK") {
          showMessage('‚úÖ Ë®òÈåÑÊèê‰∫§ÊàêÂäüÔºÅ', 'success');
          // ÈáçÁΩÆË°®ÂñÆ
          this.reset();
          document.querySelectorAll('.radio-option').forEach(option => {
            option.classList.remove('selected');
          });
          document.querySelectorAll('.checkbox-option').forEach(option => {
            option.classList.remove('checked');
          });
          document.getElementById('qr-result').classList.remove('show');
          
          // 3ÁßíÂæåÈáçÊñ∞ÂïüÁî®ÊåâÈàï
          setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Êèê‰∫§Ë®òÈåÑ';
            showMessage('');
          }, 3000);
        } else {
          throw new Error('‰º∫ÊúçÂô®ÂõûÊáâÁï∞Â∏∏');
        }
      } catch (error) {
        if (isTimeout) return;
        clearTimeout(timeoutId);
        showMessage('‚ùå Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Êèê‰∫§Ë®òÈåÑ';
      }
    });
    
    // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÁöÑÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
      // Ê™¢Êü•ÊòØÂê¶ÊîØÊè¥ÊîùÂÉèÈ†≠
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById('startQrBtn').disabled = true;
        document.getElementById('startQrBtn').textContent = '‰∏çÊîØÊè¥ÊîùÂÉèÈ†≠';
      }
      
      // Ê∑ªÂä†checkboxË¶ñË¶∫ÊïàÊûú
      document.querySelectorAll('.checkbox-option input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const option = this.closest('.checkbox-option');
          if (this.checked) {
            option.classList.add('checked');
          } else {
            option.classList.remove('checked');
          }
        });
      });
    });
  </script>
</body>
</html>

